
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>cryspy.scripts.cl_rhochi &#8212; cryspy 0.2.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">cryspy 0.2.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cryspy.scripts.cl_rhochi</h1><div class="highlight"><pre>
<span></span><span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;ikibalin&#39;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;2019_09_15&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">pycifstar</span> <span class="k">import</span> <span class="n">Global</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">cryspy.common.cl_item_constr</span> <span class="k">import</span> <span class="n">ItemConstr</span>
<span class="kn">from</span> <span class="nn">cryspy.common.cl_loop_constr</span> <span class="k">import</span> <span class="n">LoopConstr</span>
<span class="kn">from</span> <span class="nn">cryspy.common.cl_data_constr</span> <span class="k">import</span> <span class="n">DataConstr</span>
<span class="kn">from</span> <span class="nn">cryspy.common.cl_global_constr</span> <span class="k">import</span> <span class="n">GlobalConstr</span>
<span class="kn">from</span> <span class="nn">cryspy.common.cl_fitable</span> <span class="k">import</span> <span class="n">Fitable</span>

<span class="kn">import</span> <span class="nn">scipy.optimize</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="kn">from</span> <span class="nn">cryspy.cif_like.cl_crystal</span> <span class="k">import</span> <span class="n">Crystal</span>
<span class="kn">from</span> <span class="nn">cryspy.cif_like.cl_diffrn</span> <span class="k">import</span> <span class="n">Diffrn</span>
<span class="kn">from</span> <span class="nn">cryspy.cif_like.cl_pd</span> <span class="k">import</span> <span class="n">Pd</span>
<span class="kn">from</span> <span class="nn">cryspy.cif_like.cl_pd2d</span> <span class="k">import</span> <span class="n">Pd2d</span>



<div class="viewcode-block" id="RhoChi"><a class="viewcode-back" href="../../../cryspy.scripts.rhochi.html#cryspy.scripts.cl_rhochi.RhoChi">[docs]</a><span class="k">class</span> <span class="nc">RhoChi</span><span class="p">(</span><span class="n">GlobalConstr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Class to describe RhoChi container</span>

<span class="sd">Description in cif file::</span>

<span class="sd"> global_</span>

<span class="sd"> data_Fe3O4             </span>
<span class="sd"> _cell_angle_alpha 90.0                    </span>
<span class="sd"> _cell_angle_beta 90.0</span>
<span class="sd"> _cell_angle_gamma 90.0</span>
<span class="sd"> _cell_length_a 8.56212()</span>
<span class="sd"> _cell_length_b 8.56212</span>
<span class="sd"> _cell_length_c 8.56212</span>
<span class="sd"> _space_group_it_coordinate_system_code 2  </span>
<span class="sd"> _space_group_IT_number    227</span>
<span class="sd"> </span>
<span class="sd"> loop_                                     </span>
<span class="sd"> _atom_site_adp_type</span>
<span class="sd"> _atom_site_B_iso_or_equiv</span>
<span class="sd"> _atom_site_fract_x</span>
<span class="sd"> _atom_site_fract_y</span>
<span class="sd"> _atom_site_fract_z</span>
<span class="sd"> _atom_site_label</span>
<span class="sd"> _atom_site_occupancy</span>
<span class="sd"> _atom_site_type_symbol</span>
<span class="sd">  Uani 0.0 0.125 0.125 0.125 Fe3A 1.0 Fe3+</span>
<span class="sd">  Uani 0.0 0.5 0.5 0.5 Fe3B 1.0 Fe3+</span>
<span class="sd">  Uiso 0.0 0.25521 0.25521 0.25521 O1 1.0 O2-</span>
<span class="sd"> </span>
<span class="sd"> loop_                                     </span>
<span class="sd"> _atom_type_scat_length_neutron</span>
<span class="sd"> _atom_type_symbol</span>
<span class="sd">   0.945 Fe3+</span>
<span class="sd">  0.5803 O2-</span>
<span class="sd"> </span>
<span class="sd"> loop_</span>
<span class="sd"> _atom_site_aniso_U_11</span>
<span class="sd"> _atom_site_aniso_U_12</span>
<span class="sd"> _atom_site_aniso_U_13</span>
<span class="sd"> _atom_site_aniso_U_22</span>
<span class="sd"> _atom_site_aniso_U_23</span>
<span class="sd"> _atom_site_aniso_U_33</span>
<span class="sd"> _atom_site_aniso_label</span>
<span class="sd">  0.0 0.0 0.0 0.0 0.0 0.0 Fe3A</span>
<span class="sd">  0.0 0.0 0.0 0.0 0.0 0.0 Fe3B</span>
<span class="sd"> </span>
<span class="sd"> loop_</span>
<span class="sd"> _atom_site_scat_label</span>
<span class="sd"> _atom_site_scat_lande</span>
<span class="sd"> Fe3A 2.0 </span>
<span class="sd"> Fe3B 2.0 </span>
<span class="sd"> </span>
<span class="sd"> loop_     </span>
<span class="sd"> _atom_site_susceptibility_label</span>
<span class="sd"> _atom_site_susceptibility_chi_type</span>
<span class="sd"> _atom_site_susceptibility_chi_11</span>
<span class="sd"> _atom_site_susceptibility_chi_12</span>
<span class="sd"> _atom_site_susceptibility_chi_13</span>
<span class="sd"> _atom_site_susceptibility_chi_22</span>
<span class="sd"> _atom_site_susceptibility_chi_23</span>
<span class="sd"> _atom_site_susceptibility_chi_33</span>
<span class="sd">  Fe3A Cani -3.468(74) 0.0 0.0 -3.468 0.0 -3.468</span>
<span class="sd">  Fe3B Cani 3.041      0.0 0.0  3.041 0.0  3.041</span>

<span class="sd"> data_mono</span>
<span class="sd"> _setup_wavelength     0.840</span>
<span class="sd"> _setup_field          1.000</span>
<span class="sd"> </span>
<span class="sd"> _diffrn_radiation_polarization 1.0</span>
<span class="sd"> _diffrn_radiation_efficiency   1.0</span>

<span class="sd"> _extinction_mosaicity 100.0</span>
<span class="sd"> _extinction_radius    50.0</span>
<span class="sd"> _extinction_model     gauss</span>

<span class="sd"> _diffrn_orient_matrix_UB_11 6.59783</span>
<span class="sd"> _diffrn_orient_matrix_UB_12 -6.99807</span>
<span class="sd"> _diffrn_orient_matrix_UB_13 3.3663</span>
<span class="sd"> _diffrn_orient_matrix_UB_21 2.18396</span>
<span class="sd"> _diffrn_orient_matrix_UB_22 -2.60871</span>
<span class="sd"> _diffrn_orient_matrix_UB_23 -9.5302</span>
<span class="sd"> _diffrn_orient_matrix_UB_31 7.4657</span>
<span class="sd"> _diffrn_orient_matrix_UB_32 6.94702</span>
<span class="sd"> _diffrn_orient_matrix_UB_33 -0.18685</span>

<span class="sd"> _phase_label  Fe3O4</span>

<span class="sd"> loop_</span>
<span class="sd"> _diffrn_refln_index_h</span>
<span class="sd"> _diffrn_refln_index_k</span>
<span class="sd"> _diffrn_refln_index_l</span>
<span class="sd"> _diffrn_refln_fr</span>
<span class="sd"> _diffrn_refln_fr_sigma</span>
<span class="sd"> 0 0 8 0.64545 0.01329 </span>
<span class="sd"> 2 0 6 1.75682 0.04540 </span>
<span class="sd"> 0 2 6 1.67974 0.03711 </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MANDATORY_CLASSES</span> <span class="o">=</span> <span class="p">(</span><span class="n">Crystal</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">OPTIONAL_CLASSES</span> <span class="o">=</span> <span class="p">(</span><span class="n">Diffrn</span><span class="p">,</span> <span class="n">Pd</span><span class="p">,</span> <span class="n">Pd2d</span><span class="p">)</span>
    <span class="n">INTERNAL_CLASSES</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crystals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">experiments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">global_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RhoChi</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">mandatory_classes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">MANDATORY_CLASSES</span><span class="p">,</span>
                                     <span class="n">optional_classes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">OPTIONAL_CLASSES</span><span class="p">,</span>
                                     <span class="n">internal_classes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">INTERNAL_CLASSES</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_name</span> <span class="o">=</span> <span class="n">global_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crystals</span> <span class="o">=</span> <span class="n">crystals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="n">experiments</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_defined</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form_object</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">crystals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l_res</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">Crystal</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_res</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">l_res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="nd">@crystals</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">crystals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l_x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_crystals</span>
        <span class="n">l_x_in</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">l_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_x_in</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l_x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Crystal</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mandatory_objs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">l_x_in</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">experiments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l_res</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">Diffrn</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="p">[</span><span class="n">Pd</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="p">[</span><span class="n">Pd2d</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_res</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">l_res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="nd">@experiments</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">experiments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l_x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_experiments</span>
        <span class="n">l_x_in</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">l_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_x_in</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l_x</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Diffrn</span><span class="p">)</span> <span class="o">|</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Pd</span><span class="p">)</span>
                                       <span class="o">|</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Pd2d</span><span class="p">))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optional_objs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">l_x_in</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delete_crystals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_h</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mandatory_objs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mandatory_objs</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Crystal</span><span class="p">)]</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delete_experiments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_h</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">optional_objs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mandatory_objs</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span>
                          <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Diffrn</span><span class="p">)</span> <span class="o">|</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Pd</span><span class="p">)</span> <span class="o">|</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Pd2d</span><span class="p">))]</span>
        <span class="k">return</span> <span class="kc">True</span>


    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ls_out</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RhoChi:&quot;</span><span class="p">]</span>
        <span class="n">ls_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;{str(self):}&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ls_out</span><span class="p">)</span>



<div class="viewcode-block" id="RhoChi.apply_constraint"><a class="viewcode-back" href="../../../cryspy.scripts.rhochi.html#cryspy.scripts.cl_rhochi.RhoChi.apply_constraint">[docs]</a>    <span class="k">def</span> <span class="nf">apply_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">crystal</span><span class="o">.</span><span class="n">apply_constraint</span><span class="p">()</span> <span class="k">for</span> <span class="n">crystal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">crystals</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="RhoChi.calc_chi_sq"><a class="viewcode-back" href="../../../cryspy.scripts.rhochi.html#cryspy.scripts.cl_rhochi.RhoChi.calc_chi_sq">[docs]</a>    <span class="k">def</span> <span class="nf">calc_chi_sq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">calculate the integral intensity for h, k, l reflections</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_constraint</span><span class="p">()</span>
            
        <span class="n">l_crystal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crystals</span>

        <span class="n">chi_sq_res</span><span class="p">,</span> <span class="n">n_res</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
            <span class="n">chi_sq</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">calc_chi_sq</span><span class="p">(</span><span class="n">l_crystal</span><span class="p">)</span>
            <span class="n">experiment</span><span class="o">.</span><span class="n">chi_sq</span> <span class="o">=</span> <span class="n">chi_sq</span>
            <span class="n">experiment</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
            <span class="n">chi_sq_res</span> <span class="o">+=</span> <span class="n">chi_sq</span>
            <span class="n">n_res</span> <span class="o">+=</span> <span class="n">n</span>
        <span class="k">return</span> <span class="n">chi_sq_res</span><span class="p">,</span> <span class="n">n_res</span></div>
    
<div class="viewcode-block" id="RhoChi.refine"><a class="viewcode-back" href="../../../cryspy.scripts.rhochi.html#cryspy.scripts.cl_rhochi.RhoChi.refine">[docs]</a>    <span class="k">def</span> <span class="nf">refine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        optimization</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_constraint</span><span class="p">()</span>
        <span class="n">l_fitable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variables</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">l_fitable</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_message</span><span class="p">(</span><span class="s2">&quot;Variables are not found&quot;</span><span class="p">)</span>
            <span class="n">chi_sq</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_chi_sq</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_message</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;chi_sq/n {chi_sq/n:.2f} (n = {int(n):}).&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        

        <span class="n">val_0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fitable</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">fitable</span> <span class="ow">in</span> <span class="n">l_fitable</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        
        <span class="n">sign</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val_0</span> <span class="o">&gt;=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">param_0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">val_0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">e</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">sign</span>
        <span class="n">coeff_norm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">val_0</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">val_0</span><span class="p">)</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">param_0</span><span class="o">==</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">param_0</span><span class="p">)</span>
        <span class="n">hes_coeff_norm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">coeff_norm</span><span class="p">[:,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">coeff_norm</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span>

        <span class="k">def</span> <span class="nf">tempfunc</span><span class="p">(</span><span class="n">l_param</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">fitable</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">_1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_fitable</span><span class="p">,</span> <span class="n">l_param</span><span class="p">,</span> <span class="n">coeff_norm</span><span class="p">):</span>
                <span class="n">fitable</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">param</span><span class="o">*</span><span class="n">_1</span>
            <span class="n">chi_sq</span><span class="p">,</span> <span class="n">n_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_chi_sq</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">chi_sq</span><span class="o">*</span><span class="mf">1.</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">n_points</span><span class="p">))</span>

        <span class="n">chi_sq</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_chi_sq</span><span class="p">()</span>

        <span class="c1">#if self.ref[0].refin:</span>
        <span class="c1">#print(&quot;starting chi_sq/n: {:.2f} (n = {:}).&quot;.format(chi_sq*1./n, int(n)))</span>
        <span class="c1">#print(&quot;\nrefinement started for parameters:&quot;)</span>
        <span class="c1">#ls_out = &quot; &quot;.join([&quot;{:12}&quot;.format(fitable.name.rjust(12)) if len(fitable.name)&lt;=12 </span>
        <span class="c1">#                   else &quot;{:12}&quot;.format(fitable.name[-12:]) for fitable in l_fitable]) + &quot;       chi_sq&quot;</span>
        <span class="c1">#print(ls_out)</span>
        <span class="n">aa</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        res, m_error, infodict, errmsg, ier = \</span>
<span class="sd">            scipy.optimize.leastsq(tempfunc, param_0, full_output=1)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">tempfunc</span><span class="p">,</span> <span class="n">param_0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f_callback</span><span class="p">(</span><span class="n">coeff_norm</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;disp&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

        <span class="c1">#res = scipy.optimize.minimize(tempfunc, l_param_0, method=&#39;Nelder-Mead&#39;, </span>
        <span class="c1">#                              callback=self._f_callback, options = {&quot;fatol&quot;: 0.01*n})</span>

        <span class="n">bb</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1">#print(&quot;refinement complete, time {:.2f} sec.\n\nfinal chi_sq/n: {:.2f}\nstarted chi_sq/n: {:.2f}&quot;.format(bb-aa, res.fun, chi_sq*1./n))</span>
        
        <span class="n">hess_inv</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;hess_inv&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">hes_coeff_norm</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hess_inv</span><span class="p">)</span><span class="o">*</span><span class="mf">1.</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="k">for</span> <span class="n">fitable</span><span class="p">,</span> <span class="n">_1</span>  <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_fitable</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
            <span class="n">fitable</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">_1</span>
        <span class="c1">#print(&quot;experiment  chi_sq_n&quot;)</span>
        <span class="c1">#for _1 in self.experiments:</span>
        <span class="c1">#    print(&quot;{:10}: {:8.2f}&quot;.format(_1.label, _1.chi_sq/_1.n))</span>
        <span class="k">return</span> <span class="n">res</span></div>

    
    <span class="k">def</span> <span class="nf">_f_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">):</span>
        <span class="n">coeff_norm</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">res_x</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ls_out</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{:12.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_1</span><span class="o">*</span><span class="n">_2</span><span class="p">)</span> <span class="k">for</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res_x</span><span class="p">,</span> <span class="n">coeff_norm</span><span class="p">)])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">res_fun</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ls_out</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">{:12.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_fun</span><span class="o">.</span><span class="n">fun</span><span class="p">)</span>
        <span class="c1">#print(ls_out)</span>
  

<div class="viewcode-block" id="RhoChi.read_file"><a class="viewcode-back" href="../../../cryspy.scripts.rhochi.html#cryspy.scripts.cl_rhochi.RhoChi.read_file">[docs]</a>    <span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_input</span> <span class="o">=</span> <span class="n">f_name</span>
        <span class="n">star_</span> <span class="o">=</span> <span class="n">to_global</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
        <span class="n">string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">star_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_cif</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_constraint</span><span class="p">()</span></div>

<div class="viewcode-block" id="RhoChi.save_to_file"><a class="viewcode-back" href="../../../cryspy.scripts.rhochi.html#cryspy.scripts.cl_rhochi.RhoChi.save_to_file">[docs]</a>    <span class="k">def</span> <span class="nf">save_to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_input</span> <span class="o">=</span> <span class="n">f_name</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;main.rcif&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_to_files</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_cif</span><span class="p">)</span></div>


<div class="viewcode-block" id="RhoChi.save_to_files"><a class="viewcode-back" href="../../../cryspy.scripts.rhochi.html#cryspy.scripts.cl_rhochi.RhoChi.save_to_files">[docs]</a>    <span class="k">def</span> <span class="nf">save_to_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_input</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f_dir</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_input</span><span class="p">)</span>
        <span class="n">f_main</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f_dir</span><span class="p">,</span> <span class="s2">&quot;main.rcif&quot;</span><span class="p">)</span>
        <span class="n">ls_main</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ls_main</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;global_</span><span class="si">{:}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>   
            <span class="n">ls_main</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">_add_url </span><span class="si">{experiment.label:}</span><span class="s2">_data.rcif</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ls_main</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;_add_url </span><span class="si">{experiment.label:}</span><span class="s2">_calc.rcif</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">crystal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">crystals</span><span class="p">:</span>
            <span class="n">ls_main</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">crystal</span><span class="o">.</span><span class="n">to_cif</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>   
            <span class="n">ls_main</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">data_</span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>
            <span class="n">ls_main</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">params_to_cif</span><span class="p">)</span>

            <span class="n">f_data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f_dir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:}</span><span class="s2">_data.rcif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>
            <span class="n">ls_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ls_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">data_</span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>
            <span class="n">ls_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">data_to_cif</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_data</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ls_data</span><span class="p">))</span>
            <span class="n">f_calc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f_dir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:}</span><span class="s2">_calc.rcif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>
            <span class="n">ls_calc</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ls_calc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">data_</span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>
            <span class="n">ls_calc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">calc_to_cif</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_calc</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ls_calc</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_main</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ls_main</span><span class="p">))</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">cryspy 0.2.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Iurii KIBALIN.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.2.
    </div>
  </body>
</html>